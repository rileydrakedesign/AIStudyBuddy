# Story 0.3: Content Display Enhancements - Brownfield Addition

## Status

**COMPLETED** (2025-11-06)

---

## üìä Quick Reference

**What's Implemented:**
- ‚úÖ Study guide special formatting (blue border, book icon)
- ‚úÖ PDF/Summary document toggle with database-fetched summaries
- ‚úÖ DOCX download with markdown formatting (v1.3) - has formatting issues to debug
- ‚úÖ Markdown support in summary toggle (v1.4)
- ‚úÖ Backend prompts updated for markdown summaries (v1.4)
- ‚ùå Summary special formatting (REMOVED in v1.4 - now normal chat messages)
- ‚ùå Quote special formatting (REMOVED in v1.5 - to be revisited later)

**What's NOT Yet Implemented:**
- ‚è≥ Save button backend integration (currently placeholder)
- ‚è≥ Saved Materials storage/retrieval system

**Key Changes by Version:**
- **v1.1**: PDF/Summary toggle with database integration
- **v1.2**: Special formatting (study guides, summaries, quotes) + save/download UI
- **v1.3**: DOCX download with markdown parsing
- **v1.4**: Removed summary formatting, enhanced quotes, markdown summaries

**For Dev Agent:** See "Code Verification Summary" section below for exact file locations and line numbers.

---

## Story

**As a** student user,
**I want** special formatting for study guides, summaries, and quotes in chat responses, plus a document summary toggle,
**so that** I can easily recognize different response types and switch between PDF and summary views of my documents.

---

## Story Context

**Existing System Integration:**

- Integrates with: ChatItem component (`frontend/src/components/chat/chatItem.tsx`), DocumentChat component (`frontend/src/components/chat/DocumentChat.tsx`)
- Technology: React 18.3.1 + Material UI 6.1.9 + react-markdown 9.0.1
- Follows pattern: Existing message rendering in ChatItem.tsx, existing document viewer in DocumentChat.tsx
- Touch points: Chat message display (ChatItem component), document viewer header (DocumentChat component), save/download functionality (new endpoints)

---

## Acceptance Criteria

### Functional Requirements

1. **Study Guide Response - Special Formatting**
   - Assistant messages containing "study guide" (case-insensitive) render with:
     - Blue left border (4px solid, primary.main color)
     - Book icon (Material UI `MenuBook`) in top-left corner
     - Subtle blue background tint (primary.main at 5% opacity)
     - "Save" and "Download" action buttons below content (Material UI Button)
   - Detection: Check if message.content.toLowerCase() includes "study guide"
   - Applies to full message container, not individual markdown elements

2. **Summary Response - Special Formatting**
   - Assistant messages containing "summary" (case-insensitive) render with:
     - Green left border (4px solid, success.main color)
     - Document icon (Material UI `Description`) in top-left corner
     - Subtle green background tint (success.main at 5% opacity)
     - "Save" and "Download" action buttons below content
   - Detection: Check if message.content.toLowerCase() includes "summary"

3. **Quote Response - Special Formatting**
   - Assistant messages containing "quote" or begins with quotation marks render with:
     - Purple left border (4px solid, secondary.main color)
     - Quote icon (Material UI `FormatQuote`) in top-left corner
     - Subtle purple background tint (secondary.main at 5% opacity)
     - "Save" and "Download" action buttons below content
   - Detection: Check if message.content.toLowerCase() includes "quote" OR message.content.trim() starts with '"'

4. **Save and Download Actions**
   - Save button triggers Material UI Dialog modal:
     - Dialog title: "Save as..."
     - TextField for name input (default: "Untitled Study Guide" / "Untitled Summary" / "Untitled Quote")
     - Cancel and Save buttons
     - On save: Shows toast "Saving to Saved Materials (Story 0.3 complete)" (placeholder for now)
   - Download button:
     - Downloads content as .txt file (Blob + download link)
     - Filename: sanitized version of first 50 chars of content + timestamp
     - Shows toast "Downloaded successfully"

5. **Document Viewer - Summary Toggle**
   - DocumentChat component header adds toggle buttons:
     - Two Material UI ToggleButton components in ToggleButtonGroup
     - Button 1: "üìÑ PDF" (default selected)
     - Button 2: "üìù Summary"
   - Clicking "Summary":
     - Hides PDF viewer (react-pdf Document component)
     - Shows markdown summary view (Box with Typography + react-markdown)
     - Summary content: Placeholder text "Document summary coming soon. This will show an AI-generated summary with jump links." (Story 0.3 placeholder)
   - Clicking "PDF":
     - Shows PDF viewer
     - Hides summary view
   - Toggle state persists during document viewing session (not across document switches)

6. **Summary View - Jump Links**
   - Summary markdown can contain anchor links (e.g., `[Section 1](#section-1)`)
   - Clicking section link scrolls to that section within summary view (not PDF)
   - Uses standard markdown anchor behavior with `id` attributes on headers
   - Scroll behavior: smooth scroll (CSS: `scroll-behavior: smooth`)

### Integration Requirements

4. Existing ChatItem message rendering (react-markdown pipeline) continues to work unchanged for normal messages
5. Existing DocumentChat PDF viewer (react-pdf) continues to work unchanged
6. New special response formatting follows existing ChatItem layout pattern (message container with padding/borders)
7. Integration with existing markdown rendering pipeline (react-markdown, rehype-katex for math) maintained

### Quality Requirements

7. Changes are covered by manual testing (visual verification of special formatting)
8. Documentation updated in ChatItem and DocumentChat components (comment describing special formatting detection)
9. No regression in existing chat rendering or PDF viewer functionality verified through manual testing

---

## Technical Notes

**Integration Approach:**
- Enhance ChatItem component to detect response type via content string matching
- Add conditional rendering wrapper for special formatting (Box with conditional sx props)
- Add save/download UI (Dialog modal, download Blob logic)
- Enhance DocumentChat component with ToggleButtonGroup in header
- Add summary view container (Box with Typography, hidden by default)

**Existing Pattern Reference:**
- ChatItem.tsx shows existing message rendering with react-markdown
- DocumentChat.tsx shows existing PDF viewer with react-pdf Document component
- Existing Material UI theme defines primary (blue), success (green), secondary (purple) colors
- Existing markdown pipeline: react-markdown + rehype-katex (for math formulas)

**Key Constraints:**
- Must not break existing citation rendering (inline citations with click handlers)
- Must preserve existing markdown features (syntax highlighting, KaTeX math)
- Special formatting must only apply to assistant messages, not user messages
- Download functionality must work cross-browser (Blob API support required)
- Summary toggle must not affect PDF loading state or page navigation

**Implementation Approach:**
1. Add response type detection function in ChatItem.tsx (detectResponseType: "study-guide" | "summary" | "quote" | "normal")
2. Create SpecialResponseContainer component wrapping message content with conditional styling
3. Add SaveDownloadActions component (Save button ‚Üí Dialog, Download button ‚Üí Blob download)
4. Enhance DocumentChat header with ToggleButtonGroup
5. Add summary view container (initially showing placeholder text)

**Estimated Complexity:** 6-8 hours
- ChatItem special formatting: 3-4 hours
- Save/Download actions: 2-3 hours
- Document summary toggle: 1-2 hours
- Testing and polish: 1 hour

---

## Definition of Done

**Core Features (Original Implementation):**
- [x] Study guide responses render with blue border, book icon, and tint
- [x] ~~Summary responses render with green border, document icon, and tint~~ **REMOVED in v1.4** - Summaries now render as normal messages
- [x] ~~Quote responses render with purple border, quote icon, and tint~~ **REMOVED in v1.5** - Quote formatting to be revisited later
- [x] Save button opens dialog modal with name input
- [x] Save dialog shows placeholder toast (no backend integration yet)
- [x] ~~Download button downloads content as .txt file with correct filename~~ **ENHANCED in v1.3** - Now downloads as .docx with markdown formatting
- [x] Download shows success toast (updated to "Downloaded successfully as DOCX")
- [x] Document viewer shows PDF/Summary toggle buttons
- [x] ~~Clicking Summary hides PDF and shows placeholder summary text~~ **ENHANCED in v1.1** - Now fetches and displays actual stored summary from database
- [x] Clicking PDF shows PDF viewer and hides summary
- [x] Toggle state persists during document viewing session
- [x] Existing chat message rendering works unchanged (normal messages, citations, math formulas)
- [x] Existing PDF viewer works unchanged (page navigation, zoom, search)
- [x] Code follows existing patterns and standards
- [x] No console errors or warnings

**Enhancements Added:**

**v1.3 - DOCX Download:**
- [x] Download functionality changed from .txt to .docx format
- [x] Markdown parsing for DOCX (headings, bold, italic, lists, code blocks)
- [x] Document structure preservation in Word format

**v1.4 - Formatting Refinements:**
- [x] Summary special formatting removed (now normal chat messages)
- [x] ~~Quote formatting enhanced (spaced apart, italicized, 18px font)~~ **Later removed in v1.5**
- [x] ~~Backend quote prompt updated for improved formatting~~ **Later removed in v1.5**
- [x] Summary toggle enhanced with markdown plugins (remarkGfm, remarkMath, rehypeKatex)
- [x] Backend summary generation updated to produce markdown format

**v1.5 - Quote Formatting Removal:**
- [x] Quote special formatting removed (purple border, icon, enhanced spacing)
- [x] Quote detection logic removed from chatItem.tsx
- [x] Quotes now render as normal chat messages
- [x] Feature to be revisited and refined in future story

**Still To Do (Future Stories):**
- [ ] Backend integration for Save button (currently shows placeholder toast)
- [ ] "Saved Materials" collection/storage feature
- [ ] Ability to retrieve and view saved materials

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Special formatting breaks existing markdown rendering or citation clicks
- **Mitigation:** Wrap special formatting around existing markdown render, don't modify markdown pipeline, test citation clicks after changes
- **Rollback:** Revert ChatItem and DocumentChat changes, restore original rendering (git checkout chatItem.tsx DocumentChat.tsx)

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs (frontend only, download is client-side)
- [ ] Database changes: None (no backend changes for this story)
- [ ] UI changes follow existing design patterns (Material UI components, existing theme colors)
- [ ] Performance impact is negligible (string matching for response type is O(n) on message length)

---

## Dev Notes

### Integration Points
- ChatItem.tsx message rendering (react-markdown wrapper)
- DocumentChat.tsx header and PDF viewer container
- Existing markdown pipeline (react-markdown, rehype-katex)
- Existing Material UI theme (primary, success, secondary colors)

### Dependencies
- Material UI 6.1.9 (Dialog, TextField, ToggleButton, ToggleButtonGroup, icons)
- React 18.3.1 (useState for toggle state, Dialog state)
- react-markdown 9.0.1 (existing markdown rendering)
- Blob API (for download functionality, built into browsers)

### Testing Checklist
- [ ] Send chat message "Create a study guide for photosynthesis" ‚Üí response has blue border
- [ ] Send chat message "Summarize this document" ‚Üí response has green border
- [ ] Send chat message "Quote the definition of mitosis" ‚Üí response has purple border
- [ ] Click Save button ‚Üí dialog opens with name input
- [ ] Enter name and click Save ‚Üí toast shows placeholder message
- [ ] Click Download button ‚Üí .txt file downloads with correct content
- [ ] Open document ‚Üí toggle shows PDF by default
- [ ] Click Summary toggle ‚Üí PDF hides, placeholder summary shows
- [ ] Click PDF toggle ‚Üí summary hides, PDF shows
- [ ] Switch documents ‚Üí toggle resets to PDF
- [ ] Existing citations in normal messages still clickable
- [ ] Math formulas still render correctly (KaTeX)
- [ ] No console errors

### Special Formatting Detection Logic
```typescript
function detectResponseType(content: string): "study-guide" | "summary" | "quote" | "normal" {
  const lower = content.toLowerCase();
  if (lower.includes("study guide")) return "study-guide";
  if (lower.includes("summary")) return "summary";
  if (lower.includes("quote") || content.trim().startsWith('"')) return "quote";
  return "normal";
}
```

### Download Implementation Pattern
```typescript
function downloadAsText(content: string, filename: string) {
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Story created from UI Enhancement Goals PRD | John (PM Agent) |
| 2025-11-03 | 1.1 | Implemented PDF/Summary toggle feature with direct database summary fetching | James (Dev Agent) |
| 2025-11-04 | 1.2 | Implemented special formatting for study guides, summaries, and quotes with save/download actions | James (Dev Agent) |
| 2025-11-06 | 1.3 | Enhanced download to export as DOCX with markdown formatting applied instead of plain text | John (PM Agent) |
| 2025-11-06 | 1.4 | Refinements: Removed summary special formatting (now normal chats), updated quote formatting (spaced apart, italicized), enhanced summary toggle with markdown plugins, updated backend prompts for markdown summaries and improved quote format | John (PM Agent) |
| 2025-11-06 | 1.5 | Removed quote special formatting - feature to be revisited and refined in future story | James (Dev Agent) |

---

## Code Verification Summary

**Verified on 2025-11-06 by PM Agent (John)**

All items have been verified against actual code implementation:

### ‚úÖ **IMPLEMENTED & VERIFIED:**

**Frontend (`frontend/src/components/chat/chatItem.tsx`):**
- [x] Study guide special formatting: Blue border, book icon (line ~74-80)
- [x] Summary special formatting REMOVED: No longer in ResponseType or getSpecialFormatting (v1.4)
- [x] Quote special formatting REMOVED: Purple border, quote icon, parseQuotes function all removed (v1.5)
- [x] DOCX download: downloadAsDocx function (line ~120-248), .docx extension (line ~754) - has formatting issues to debug
- [x] Save/Download buttons render for special response types (verified in render section)

**Frontend (`frontend/src/components/chat/DocumentChat.tsx`):**
- [x] PDF/Summary toggle buttons (verified in imports and state)
- [x] Summary fetched from database: getDocumentSummary API call (line 229)
- [x] Markdown plugins for summary: remarkGfm, remarkMath, rehypeKatex (line 13-15, 634-635)
- [x] ReactMarkdown with plugins rendering summaryContent (line 633-638)

**Backend (`backend/python_scripts/prompts.json`):**
- [x] ~~Quote prompt updated: Format specifies quotes on separate lines with blank lines between (line 6)~~ **No longer used after v1.5 quote removal**

**Backend (`backend/python_scripts/load_data.py`):**
- [x] Summary generation updated: Markdown formatting instructions in prompt (line 148-163)

**Dependencies:**
- [x] docx package installed in package.json (verified via npm install output)

### ‚ùå **NOT YET IMPLEMENTED (Future Work):**

- [ ] Save button backend integration (currently placeholder toast in chatItem.tsx line 745)
- [ ] "Saved Materials" collection/database schema
- [ ] Saved materials retrieval API endpoints
- [ ] Saved materials UI/page for viewing saved content

### üìù **Key File Locations for Dev Verification:**

**Frontend Changes:**
- `frontend/src/components/chat/chatItem.tsx` (lines ~60-65: type detection; ~120-248: downloadAsDocx; ~750-760: download handler)
- `frontend/src/components/chat/DocumentChat.tsx` (lines 13-15: markdown imports; 220-246: summary fetch; 633-638: markdown rendering)

**Backend Changes:**
- `backend/python_scripts/prompts.json` (line 6: quote_finding prompt)
- `backend/python_scripts/load_data.py` (lines 148-163: summarize_document function)

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes

**Final Status (2025-11-06 - v1.5):**
Story 0.3 is COMPLETE. All core features implemented with the following refinements:
- Study guide special formatting (blue border, book icon) - ACTIVE
- PDF/Summary toggle with database integration - ACTIVE
- DOCX download with markdown formatting - ACTIVE (has known formatting issues to be addressed in future story)
- Quote special formatting - REMOVED (to be revisited in future story)
- Summary special formatting - REMOVED (summaries render as normal chat messages)
- Save button UI - IMPLEMENTED (backend integration deferred to future story)

---

Implemented all features for Story 0.3:

**1. PDF/Summary Toggle (Completed)**:
- Added ToggleButtonGroup with PDF and Summary buttons to DocumentChat header
- Implemented viewMode state management (defaults to "pdf")
- Toggle state resets to PDF when switching documents
- Direct database query fetches stored summary without LLM processing
- Simple "Loading summary..." text message during fetch
- ReactMarkdown rendering with styled output

**2. Special Response Formatting (Partially Completed)**:
- Study guide detection: Messages containing "study guide" (case-insensitive)
  - Blue left border (4px solid, primary.main color)
  - Book icon (MenuBook) in top-right corner
  - Subtle blue background tint (5% opacity)

- Summary detection: REMOVED in v1.4 - summaries now render as normal chat messages

- Quote detection: REMOVED in v1.5 - quotes now render as normal chat messages
  - Feature to be revisited and refined in future story

**3. Save and Download Actions (Completed)**:
- Save button opens Material UI Dialog with name input
- Default names: "Untitled Study Guide", "Untitled Summary", "Untitled Quote"
- Save shows placeholder toast: "Saving to Saved Materials (Story 0.3 complete)"
- Download button creates DOCX file with markdown formatting applied (headings, bold, italic, lists, code blocks)
- Uses `docx` library to convert markdown to formatted Word document
- Download shows toast: "Downloaded successfully as DOCX"
- Both buttons appear only for special response types

**4. Backend Summary Endpoint (Completed)**:
- Created GET /documents/:docId/summary REST endpoint
- Queries study_materials2 collection directly using ChunkModel
- Returns raw stored summary text without LLM processing
- Proper authentication and error handling

**5. Refinements (Version 1.4 - Completed)**:
- **Removed** summary special formatting - summaries now render as normal chat messages
- **Enhanced** ~~quote formatting~~ (later removed in v1.5):
  - ~~Quotes displayed spaced apart (3-unit bottom margin, 2-unit top margin)~~
  - ~~Italicized text (18px font size, 1.8 line height)~~
  - ~~Each quote parsed from lines starting with quotation marks~~
  - ~~Backend prompt updated to format quotes with blank lines between them~~
- **Enhanced** summary toggle in DocumentChat:
  - Added remarkGfm, remarkMath, and rehypeKatex plugins for full markdown support
  - Summaries now support math formulas, code blocks, tables, and GitHub-flavored markdown
- **Updated** backend summary generation:
  - Modified summarize_document() prompt to generate structured markdown
  - Summaries now include headings (##, ###), bold text, bullet points, and code formatting

**6. Version 1.5 Changes - Quote Removal (Completed)**:
- **Removed** quote special formatting (purple border, icon, enhanced spacing)
- **Removed** parseQuotes function and quote detection logic
- **Removed** unused imports (FormatQuoteIcon, DescriptionIcon)
- **Fixed** TypeScript error in DOCX downloadAsDocx function (HeadingLevel type)
- Quotes now render as normal chat messages
- Feature to be revisited and refined in future story

**Existing Features Preserved**:
- PDF viewer and chat functionality unchanged
- Citations, math formulas (KaTeX), code highlighting all working
- No regression in existing features

### File List
Modified source files:
- `frontend/src/components/chat/chatItem.tsx` - Special formatting detection (removed summary in v1.4, removed quote in v1.5), save/download actions, dialog, DOCX conversion, fixed TypeScript error
- `frontend/src/components/chat/DocumentChat.tsx` - Toggle buttons, viewMode state, direct summary fetching, markdown plugins for summary rendering
- `frontend/src/helpers/api-communicators.ts` - getDocumentSummary API function
- `frontend/package.json` - Added docx library for DOCX generation
- `backend/src/controllers/document_controllers.ts` - getDocumentSummary controller
- `backend/src/routes/document_routes.ts` - GET /:docId/summary route
- `backend/python_scripts/prompts.json` - Updated quote_finding prompt (v1.4, no longer actively used after v1.5)
- `backend/python_scripts/load_data.py` - Updated summarize_document() to generate markdown formatted summaries

---

## Previous Story Reference

**Story 0.2:** Core Layout Enhancements (sidebar, mobile blocking)

---

*ü§ñ Generated with [Claude Code](https://claude.com/claude-code)*

*Co-Authored-By: Claude <noreply@anthropic.com>*
