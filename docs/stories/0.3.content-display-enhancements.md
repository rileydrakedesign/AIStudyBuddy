# Story 0.3: Content Display Enhancements - Brownfield Addition

## Status

**READY FOR IMPLEMENTATION**

---

## Story

**As a** student user,
**I want** special formatting for study guides, summaries, and quotes in chat responses, plus a document summary toggle,
**so that** I can easily recognize different response types and switch between PDF and summary views of my documents.

---

## Story Context

**Existing System Integration:**

- Integrates with: ChatItem component (`frontend/src/components/chat/chatItem.tsx`), DocumentChat component (`frontend/src/components/chat/DocumentChat.tsx`)
- Technology: React 18.3.1 + Material UI 6.1.9 + react-markdown 9.0.1
- Follows pattern: Existing message rendering in ChatItem.tsx, existing document viewer in DocumentChat.tsx
- Touch points: Chat message display (ChatItem component), document viewer header (DocumentChat component), save/download functionality (new endpoints)

---

## Acceptance Criteria

### Functional Requirements

1. **Study Guide Response - Special Formatting**
   - Assistant messages containing "study guide" (case-insensitive) render with:
     - Blue left border (4px solid, primary.main color)
     - Book icon (Material UI `MenuBook`) in top-left corner
     - Subtle blue background tint (primary.main at 5% opacity)
     - "Save" and "Download" action buttons below content (Material UI Button)
   - Detection: Check if message.content.toLowerCase() includes "study guide"
   - Applies to full message container, not individual markdown elements

2. **Summary Response - Special Formatting**
   - Assistant messages containing "summary" (case-insensitive) render with:
     - Green left border (4px solid, success.main color)
     - Document icon (Material UI `Description`) in top-left corner
     - Subtle green background tint (success.main at 5% opacity)
     - "Save" and "Download" action buttons below content
   - Detection: Check if message.content.toLowerCase() includes "summary"

3. **Quote Response - Special Formatting**
   - Assistant messages containing "quote" or begins with quotation marks render with:
     - Purple left border (4px solid, secondary.main color)
     - Quote icon (Material UI `FormatQuote`) in top-left corner
     - Subtle purple background tint (secondary.main at 5% opacity)
     - "Save" and "Download" action buttons below content
   - Detection: Check if message.content.toLowerCase() includes "quote" OR message.content.trim() starts with '"'

4. **Save and Download Actions**
   - Save button triggers Material UI Dialog modal:
     - Dialog title: "Save as..."
     - TextField for name input (default: "Untitled Study Guide" / "Untitled Summary" / "Untitled Quote")
     - Cancel and Save buttons
     - On save: Shows toast "Saving to Saved Materials (Story 0.3 complete)" (placeholder for now)
   - Download button:
     - Downloads content as .txt file (Blob + download link)
     - Filename: sanitized version of first 50 chars of content + timestamp
     - Shows toast "Downloaded successfully"

5. **Document Viewer - Summary Toggle**
   - DocumentChat component header adds toggle buttons:
     - Two Material UI ToggleButton components in ToggleButtonGroup
     - Button 1: "üìÑ PDF" (default selected)
     - Button 2: "üìù Summary"
   - Clicking "Summary":
     - Hides PDF viewer (react-pdf Document component)
     - Shows markdown summary view (Box with Typography + react-markdown)
     - Summary content: Placeholder text "Document summary coming soon. This will show an AI-generated summary with jump links." (Story 0.3 placeholder)
   - Clicking "PDF":
     - Shows PDF viewer
     - Hides summary view
   - Toggle state persists during document viewing session (not across document switches)

6. **Summary View - Jump Links**
   - Summary markdown can contain anchor links (e.g., `[Section 1](#section-1)`)
   - Clicking section link scrolls to that section within summary view (not PDF)
   - Uses standard markdown anchor behavior with `id` attributes on headers
   - Scroll behavior: smooth scroll (CSS: `scroll-behavior: smooth`)

### Integration Requirements

4. Existing ChatItem message rendering (react-markdown pipeline) continues to work unchanged for normal messages
5. Existing DocumentChat PDF viewer (react-pdf) continues to work unchanged
6. New special response formatting follows existing ChatItem layout pattern (message container with padding/borders)
7. Integration with existing markdown rendering pipeline (react-markdown, rehype-katex for math) maintained

### Quality Requirements

7. Changes are covered by manual testing (visual verification of special formatting)
8. Documentation updated in ChatItem and DocumentChat components (comment describing special formatting detection)
9. No regression in existing chat rendering or PDF viewer functionality verified through manual testing

---

## Technical Notes

**Integration Approach:**
- Enhance ChatItem component to detect response type via content string matching
- Add conditional rendering wrapper for special formatting (Box with conditional sx props)
- Add save/download UI (Dialog modal, download Blob logic)
- Enhance DocumentChat component with ToggleButtonGroup in header
- Add summary view container (Box with Typography, hidden by default)

**Existing Pattern Reference:**
- ChatItem.tsx shows existing message rendering with react-markdown
- DocumentChat.tsx shows existing PDF viewer with react-pdf Document component
- Existing Material UI theme defines primary (blue), success (green), secondary (purple) colors
- Existing markdown pipeline: react-markdown + rehype-katex (for math formulas)

**Key Constraints:**
- Must not break existing citation rendering (inline citations with click handlers)
- Must preserve existing markdown features (syntax highlighting, KaTeX math)
- Special formatting must only apply to assistant messages, not user messages
- Download functionality must work cross-browser (Blob API support required)
- Summary toggle must not affect PDF loading state or page navigation

**Implementation Approach:**
1. Add response type detection function in ChatItem.tsx (detectResponseType: "study-guide" | "summary" | "quote" | "normal")
2. Create SpecialResponseContainer component wrapping message content with conditional styling
3. Add SaveDownloadActions component (Save button ‚Üí Dialog, Download button ‚Üí Blob download)
4. Enhance DocumentChat header with ToggleButtonGroup
5. Add summary view container (initially showing placeholder text)

**Estimated Complexity:** 6-8 hours
- ChatItem special formatting: 3-4 hours
- Save/Download actions: 2-3 hours
- Document summary toggle: 1-2 hours
- Testing and polish: 1 hour

---

## Definition of Done

- [ ] Study guide responses render with blue border, book icon, and tint
- [ ] Summary responses render with green border, document icon, and tint
- [ ] Quote responses render with purple border, quote icon, and tint
- [ ] Save button opens dialog modal with name input
- [ ] Save dialog shows placeholder toast (no backend integration yet)
- [ ] Download button downloads content as .txt file with correct filename
- [ ] Download shows success toast
- [x] Document viewer shows PDF/Summary toggle buttons
- [x] Clicking Summary hides PDF and shows placeholder summary text
- [x] Clicking PDF shows PDF viewer and hides summary
- [x] Toggle state persists during document viewing session
- [x] Existing chat message rendering works unchanged (normal messages, citations, math formulas)
- [x] Existing PDF viewer works unchanged (page navigation, zoom, search)
- [x] Code follows existing patterns and standards
- [x] No console errors or warnings

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Special formatting breaks existing markdown rendering or citation clicks
- **Mitigation:** Wrap special formatting around existing markdown render, don't modify markdown pipeline, test citation clicks after changes
- **Rollback:** Revert ChatItem and DocumentChat changes, restore original rendering (git checkout chatItem.tsx DocumentChat.tsx)

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs (frontend only, download is client-side)
- [ ] Database changes: None (no backend changes for this story)
- [ ] UI changes follow existing design patterns (Material UI components, existing theme colors)
- [ ] Performance impact is negligible (string matching for response type is O(n) on message length)

---

## Dev Notes

### Integration Points
- ChatItem.tsx message rendering (react-markdown wrapper)
- DocumentChat.tsx header and PDF viewer container
- Existing markdown pipeline (react-markdown, rehype-katex)
- Existing Material UI theme (primary, success, secondary colors)

### Dependencies
- Material UI 6.1.9 (Dialog, TextField, ToggleButton, ToggleButtonGroup, icons)
- React 18.3.1 (useState for toggle state, Dialog state)
- react-markdown 9.0.1 (existing markdown rendering)
- Blob API (for download functionality, built into browsers)

### Testing Checklist
- [ ] Send chat message "Create a study guide for photosynthesis" ‚Üí response has blue border
- [ ] Send chat message "Summarize this document" ‚Üí response has green border
- [ ] Send chat message "Quote the definition of mitosis" ‚Üí response has purple border
- [ ] Click Save button ‚Üí dialog opens with name input
- [ ] Enter name and click Save ‚Üí toast shows placeholder message
- [ ] Click Download button ‚Üí .txt file downloads with correct content
- [ ] Open document ‚Üí toggle shows PDF by default
- [ ] Click Summary toggle ‚Üí PDF hides, placeholder summary shows
- [ ] Click PDF toggle ‚Üí summary hides, PDF shows
- [ ] Switch documents ‚Üí toggle resets to PDF
- [ ] Existing citations in normal messages still clickable
- [ ] Math formulas still render correctly (KaTeX)
- [ ] No console errors

### Special Formatting Detection Logic
```typescript
function detectResponseType(content: string): "study-guide" | "summary" | "quote" | "normal" {
  const lower = content.toLowerCase();
  if (lower.includes("study guide")) return "study-guide";
  if (lower.includes("summary")) return "summary";
  if (lower.includes("quote") || content.trim().startsWith('"')) return "quote";
  return "normal";
}
```

### Download Implementation Pattern
```typescript
function downloadAsText(content: string, filename: string) {
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Story created from UI Enhancement Goals PRD | John (PM Agent) |
| 2025-11-03 | 1.1 | Implemented PDF/Summary toggle feature with chat-based summary fetching | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes
Implemented PDF/Summary toggle feature for document viewer:

**Toggle UI (Completed)**:
- Added ToggleButtonGroup with PDF and Summary buttons to DocumentChat header
- Implemented viewMode state management (defaults to "pdf")
- Toggle state resets to PDF when switching documents
- Simple "Loading summary..." text message during fetch

**Summary Fetching (Completed)**:
- Uses existing chat-based flow to fetch summaries (same as when users request summaries in chat)
- Pre-fetches summary in background when document loads for instant toggle response
- Sends ephemeral chat request: "Please provide a summary of this document"
- Python backend handles as "doc_summary" mode via existing semantic_search.py
- No new REST endpoints or database models required

**Frontend Summary Display (Completed)**:
- Displays summary content with ReactMarkdown for proper formatting
- Simple loading message: "Loading summary..." (matches PDF loading pattern)
- Error handling with user-friendly error messages
- Styled markdown output (headings, paragraphs, lists, links)

**Existing Features Preserved**:
- PDF viewer and chat functionality remain unchanged
- No regression in existing features
- Reuses existing, tested infrastructure

**Note:** Study guide/summary/quote special formatting features were deferred per user request.

### File List
Modified source files:
- `frontend/src/components/chat/DocumentChat.tsx` - Toggle buttons, viewMode state, chat-based summary fetching, markdown rendering

---

## Previous Story Reference

**Story 0.2:** Core Layout Enhancements (sidebar, mobile blocking)

---

*ü§ñ Generated with [Claude Code](https://claude.com/claude-code)*

*Co-Authored-By: Claude <noreply@anthropic.com>*
