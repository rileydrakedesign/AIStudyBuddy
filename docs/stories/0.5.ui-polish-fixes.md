# Story 0.5: UI Polish & Fixes - Brownfield Addition

## Status

**READY FOR IMPLEMENTATION**

---

## Story

**As a** student user,
**I want** formula rendering to be more robust and toast notifications to appear in a non-intrusive location,
**so that** I can view complex math content without overflow issues and receive notifications without blocking my workflow.

---

## Story Context

**Existing System Integration:**

- Integrates with: ChatItem component (formula rendering), Toaster component (`frontend/src/components/ui/toaster.tsx`), Chat page (chat window height)
- Technology: React 18.3.1 + KaTeX 0.16.20 + react-markdown 9.0.1 + Radix UI Toast primitives
- Follows pattern: Existing markdown rendering pipeline (react-markdown + rehype-katex), existing Toaster component
- Touch points: ChatItem message rendering, Toaster ToastViewport positioning, Chat page container CSS

---

## Acceptance Criteria

### Functional Requirements

1. **Formula Rendering - Error Boundary**
   - Wrap KaTeX formula rendering in React Error Boundary component
   - If KaTeX rendering fails (e.g., invalid LaTeX syntax):
     - Show LaTeX source code in monospace font (e.g., `$$\invalid{syntax}$$`)
     - Show small warning icon (Material UI `Warning` icon, size 16px, color: warning.main)
     - Do not crash entire message rendering
   - Error boundary catches errors from rehype-katex plugin during markdown processing
   - Fallback UI: `<code style="font-family: monospace; color: #ff9800;">{latexSource}</code> ‚ö†Ô∏è`

2. **Formula Rendering - Overflow Handling**
   - Apply CSS to formula containers (`.katex-display` class):
     - `overflow-x: auto` (horizontal scroll for long formulas)
     - `max-width: 100%` (prevent container overflow)
     - `padding: 8px 0` (spacing above/below formula)
   - Inline formulas (`.katex` class):
     - `max-width: 100%` (prevent inline overflow)
     - `display: inline-block` (allow wrapping)
     - `overflow-x: auto` (scroll if needed)
   - Ensures formulas don't break chat message layout or cause horizontal page scroll

3. **Chat Window - Fixed Height**
   - Chat.tsx main chat container applies CSS:
     - `max-height: calc(100vh - 200px)` (account for header + input area)
     - `overflow-y: auto` (vertical scroll for message history)
     - `scroll-behavior: smooth` (smooth auto-scroll to bottom on new message)
   - Auto-scroll to bottom when new assistant message arrives
   - User can scroll up to view history without layout jumping

4. **Toast Notifications - Repositioning**
   - Update Toaster component (or ToastViewport in toast.tsx):
     - Change anchor position to bottom-right
     - If using Radix UI Toast: Update `ToastViewport` CSS in `toast.tsx`
       - `position: fixed`
       - `bottom: 24px` (was likely top)
       - `right: 24px`
       - `z-index: 9999` (ensure visibility above all elements)
     - If using react-hot-toast (found in Chat.tsx:38):
       - Update toast container position via `toastOptions` in main.tsx or where toast is configured
       - Position: `{ position: 'bottom-right' }`
   - Toasts stack vertically from bottom-right corner
   - Do not block main content area or chat input

### Integration Requirements

4. Existing markdown rendering (react-markdown + rehype-katex) continues to work unchanged for valid formulas
5. Existing toast functionality (success, error, info toasts) continues to work unchanged
6. New error boundary only activates on KaTeX rendering errors, does not affect other message content
7. Integration with existing chat auto-scroll behavior (scroll to bottom on new message) maintained

### Quality Requirements

7. Changes are covered by manual testing (test invalid LaTeX, long formulas, toast positioning)
8. Error boundary includes error logging to console (console.error) for debugging
9. No regression in existing formula rendering (valid LaTeX) or toast notifications verified through manual testing

---

## Technical Notes

**Integration Approach:**

**Formula Error Boundary:**
- Create `<FormulaErrorBoundary>` component extending React.Component with componentDidCatch
- Wrap markdown rendering in ChatItem with error boundary
- Error boundary shows fallback UI (LaTeX source + warning icon)

**Formula Overflow CSS:**
- Add global CSS or scoped styles in ChatItem for `.katex` and `.katex-display` classes
- Use CSS modules or styled-components if preferred, or add to global stylesheet

**Chat Window Fixed Height:**
- Update Chat.tsx main container Box component with sx prop for max-height
- Add useEffect to auto-scroll to bottom when messages change

**Toast Repositioning:**
- Option 1: If using Radix UI Toast (likely based on toaster.tsx):
  - Update `toast.tsx` ToastViewport CSS with bottom-right positioning
  - Update z-index to ensure visibility
- Option 2: If using react-hot-toast (imported in Chat.tsx:38):
  - Configure toast position in main.tsx or App.tsx: `toast.configure({ position: 'bottom-right' })`
  - May need to remove react-hot-toast and use Radix UI Toast consistently

**Existing Pattern Reference:**
- ChatItem.tsx shows existing react-markdown rendering
- Toaster.tsx shows Radix UI Toast setup with ToastViewport
- Chat.tsx:38 imports react-hot-toast (may need to unify toast library)
- Error boundaries follow standard React pattern (componentDidCatch lifecycle)

**Key Constraints:**
- Error boundary must not catch errors from other components (scope to formula rendering only)
- Formula overflow CSS must not break inline formulas or display formulas
- Chat window height must account for header (AppBar) and input area
- Toast repositioning must not break existing toast dismiss functionality
- Must unify toast library (either Radix UI Toast OR react-hot-toast, not both)

**Implementation Approach:**

1. Create `FormulaErrorBoundary.tsx` component with componentDidCatch
2. Wrap markdown rendering in ChatItem with error boundary
3. Add CSS for `.katex` and `.katex-display` classes (formula overflow)
4. Update Chat.tsx container with max-height and overflow-y
5. Add auto-scroll effect in Chat.tsx (useEffect watching messages array)
6. Update toast positioning:
   - If using Radix UI: Update `toast.tsx` ToastViewport CSS
   - If using react-hot-toast: Remove and migrate to Radix UI OR update react-hot-toast config
   - Recommend: Migrate to Radix UI Toast (already in use in toaster.tsx) for consistency

**Estimated Complexity:** 3-4 hours
- Formula error boundary: 1 hour
- Formula overflow CSS: 30 minutes
- Chat window fixed height: 30 minutes
- Toast repositioning: 1-2 hours (depends on library unification)
- Testing: 1 hour

---

## Definition of Done

- [ ] Formula error boundary wraps markdown rendering in ChatItem
- [ ] Invalid LaTeX formulas show source code + warning icon (no crash)
- [ ] Valid LaTeX formulas render correctly (regression test)
- [ ] Long formulas have horizontal scroll (overflow-x: auto)
- [ ] Formulas respect max-width (no container overflow)
- [ ] Chat window has fixed height (calc(100vh - 200px))
- [ ] Chat window auto-scrolls to bottom on new message
- [ ] User can scroll up to view history
- [ ] Toast notifications appear in bottom-right corner
- [ ] Toast stack vertically from bottom-right
- [ ] Toast z-index ensures visibility above all elements
- [ ] Existing toast functionality works (success, error, info)
- [ ] Error boundary logs errors to console
- [ ] Code follows existing patterns and standards
- [ ] No console errors or warnings (except logged formula errors)

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Error boundary catches too many errors or breaks valid formula rendering
- **Mitigation:** Scope error boundary tightly to formula rendering only, test with comprehensive LaTeX examples (valid and invalid)
- **Rollback:** Remove error boundary wrapper, revert to original markdown rendering (formulas may crash on error)

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs (frontend CSS/component changes only)
- [ ] Database changes: None
- [ ] UI changes follow existing design patterns (React error boundaries, CSS best practices)
- [ ] Performance impact is negligible (error boundary only activates on formula errors)

---

## Dev Notes

### Integration Points

**Frontend:**
- ChatItem.tsx (wrap markdown with error boundary, add formula overflow CSS)
- Chat.tsx (add max-height, overflow-y, auto-scroll effect)
- toast.tsx or toaster.tsx (update ToastViewport positioning)
- Global CSS or styled-components (formula overflow styles)

### Dependencies
- React 18.3.1 (Error Boundary, useEffect for auto-scroll)
- KaTeX 0.16.20 + rehype-katex 7.0.1 (existing formula rendering)
- Radix UI Toast OR react-hot-toast (toast library - needs unification)
- Material UI 6.1.9 (Warning icon for error fallback)

### Testing Checklist

**Formula Rendering:**
- [ ] Send message with valid inline formula `$E = mc^2$` ‚Üí renders correctly
- [ ] Send message with valid display formula `$$\int_0^1 x^2 dx$$` ‚Üí renders correctly
- [ ] Send message with invalid formula `$$\invalid{syntax}$$` ‚Üí shows source code + warning icon
- [ ] Send message with very long formula ‚Üí horizontal scroll appears
- [ ] Formula overflow does not break chat layout
- [ ] Error logged to console for invalid formula

**Chat Window:**
- [ ] Chat window height is fixed (max-height: calc(100vh - 200px))
- [ ] Send many messages ‚Üí vertical scroll appears
- [ ] New assistant message arrives ‚Üí auto-scrolls to bottom
- [ ] Scroll up manually ‚Üí stays at scrolled position
- [ ] Send new message ‚Üí scrolls to bottom again

**Toast Notifications:**
- [ ] Trigger success toast ‚Üí appears in bottom-right
- [ ] Trigger error toast ‚Üí appears in bottom-right
- [ ] Multiple toasts ‚Üí stack vertically
- [ ] Toast does not block chat input
- [ ] Toast auto-dismisses after timeout
- [ ] Toast z-index above all elements

### Formula Error Boundary Component
```typescript
import React, { Component, ReactNode } from 'react';
import WarningIcon from '@mui/icons-material/Warning';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

class FormulaErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Formula rendering error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <code style={{ fontFamily: 'monospace', color: '#ff9800' }}>
          {/* Show LaTeX source if available */}
          [Formula rendering failed] <WarningIcon sx={{ fontSize: 16, verticalAlign: 'middle' }} />
        </code>
      );
    }

    return this.props.children;
  }
}

export default FormulaErrorBoundary;
```

### Formula Overflow CSS
```css
/* Add to global CSS or ChatItem scoped styles */
.katex-display {
  overflow-x: auto;
  max-width: 100%;
  padding: 8px 0;
}

.katex {
  max-width: 100%;
  display: inline-block;
  overflow-x: auto;
}
```

### Chat Window CSS (Chat.tsx)
```typescript
<Box
  sx={{
    maxHeight: 'calc(100vh - 200px)',
    overflowY: 'auto',
    scrollBehavior: 'smooth',
    padding: 2,
  }}
>
  {/* Chat messages */}
</Box>
```

### Auto-scroll Effect (Chat.tsx)
```typescript
const messagesEndRef = useRef<HTMLDivElement>(null);

useEffect(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, [messages]);

// In JSX:
<div ref={messagesEndRef} />
```

### Toast Positioning (toast.tsx)
```typescript
// Update ToastViewport CSS
const ToastViewport = styled(ToastPrimitive.Viewport)`
  position: fixed;
  bottom: 24px;  /* Changed from top */
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-width: 400px;
`;
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Story created from UI Enhancement Goals PRD | John (PM Agent) |

---

## Previous Story Reference

**Story 0.4:** Profile & Account Management (email change, password change, delete account)

---

*ü§ñ Generated with [Claude Code](https://claude.com/claude-code)*

*Co-Authored-By: Claude <noreply@anthropic.com>*
